name: Prefetch Letterboxd Ratings

on:
  schedule:
    # Daily at 02:10 UTC (quiet traffic window)
    - cron: "10 2 * * *"
  workflow_dispatch:

jobs:
  prefetch:
    runs-on: ubuntu-latest
    steps:
      - name: Compute Paris date
        id: date
        run: echo "target_date=$(TZ=Europe/Paris date +%F)" >> "$GITHUB_OUTPUT"

      - name: Trigger prefetch endpoint
        env:
          PREFETCH_BASE_URL: ${{ secrets.PREFETCH_BASE_URL }}
          PREFETCH_TOKEN: ${{ secrets.PREFETCH_TOKEN }}
          TARGET_DATE: ${{ steps.date.outputs.target_date }}
        run: |
          if [ -z "$PREFETCH_BASE_URL" ] || [ -z "$PREFETCH_TOKEN" ]; then
            echo "Missing PREFETCH_BASE_URL or PREFETCH_TOKEN GitHub secret"
            exit 1
          fi
          URL="${PREFETCH_BASE_URL%/}/prefetch-letterboxd"
          echo "Calling ${URL} for date ${TARGET_DATE}"
          # Free Render can be cold/asleep; do small batch + retry for wake-up windows.
          SUCCESS=0
          for ATTEMPT in 1 2 3; do
            HTTP_CODE=$(curl -sS -o /tmp/prefetch.json -w "%{http_code}" \
              --get "$URL" \
              --data-urlencode "date=${TARGET_DATE}" \
              --data-urlencode "max_movies=25" \
              --data-urlencode "sleep=0.15" \
              --data-urlencode "token=${PREFETCH_TOKEN}")
            echo "Attempt ${ATTEMPT} -> HTTP ${HTTP_CODE}"
            cat /tmp/prefetch.json || true
            if [ "${HTTP_CODE}" -ge 200 ] && [ "${HTTP_CODE}" -lt 300 ]; then
              SUCCESS=1
              break
            fi
            sleep 20
          done
          if [ "${SUCCESS}" -ne 1 ]; then
            exit 1
          fi
