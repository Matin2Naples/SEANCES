<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Séance(s)</title>
    <link rel="manifest" href="/manifest.json" />
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png" />
    <meta name="theme-color" content="#000000" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      html, body {
        margin: 0;
        padding: 0;
        background: #929299;
      }
      #root {
        min-height: 100vh;
      }
      .seances-loader {
        width: 72px;
        height: 72px;
        position: relative;
      }
      .seances-dot {
        position: absolute;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #ffffff;
        filter: brightness(0);
        animation: seances-pulse 1.1s linear infinite;
      }
      @keyframes seances-pulse {
        0% { filter: brightness(1); }
        10% { filter: brightness(0.9); }
        20% { filter: brightness(0.8); }
        30% { filter: brightness(0.7); }
        40% { filter: brightness(0.6); }
        50% { filter: brightness(0.5); }
        60% { filter: brightness(0.4); }
        70% { filter: brightness(0.3); }
        80% { filter: brightness(0.2); }
        90% { filter: brightness(0.1); }
        100% { filter: brightness(0); }
      }
      .seances-garamond {
        font-family: "EB Garamond", serif;
        font-size: 16px;
        line-height: 20px;
        margin: 0;
        color: #000000;
      }
      .seances-ellipsis {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .seances-title { margin: 0; font-weight: 600; }
      .seances-director { font-weight: 400; margin: 0 0 12px 0; }
      .seances-duration { margin: 0; }
      .seances-avec { margin: 0; }
      .seances-loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 100svh;
        background: #000000;
        z-index: 2000;
        overflow: hidden;
        transition: height 600ms ease-in-out;
      }
      .seances-loading-logo {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 24px;
        font-weight: 400;
        color: #c1ff00;
        font-family: Helvetica, Arial, sans-serif;
      }
      .seances-loading-ellipsis {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        width: 3ch;
        text-align: right;
        font-size: 20px;
        line-height: 20px;
        color: #929299;
        font-family: Helvetica, Arial, sans-serif;
        letter-spacing: 1px;
        white-space: pre;
      }
      .seances-secondary-overlay {
        position: fixed;
        top: 56px;
        left: 0;
        right: 0;
        bottom: 0;
        background: #929299;
        z-index: 1500;
      }
      .seances-header-ellipsis {
        position: absolute;
        right: 0px;
        top: 50%;
        transform: translateY(-50%);
        width: 3ch;
        text-align: right;
        font-size: 20px;
        line-height: 20px;
        color: #929299;
        font-family: Helvetica, Arial, sans-serif;
        letter-spacing: 1px;
        white-space: pre;
        userSelect: "none";
      }
</style>
  </head>
  <body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      const PlusIcon = ({ size = 20, color = "#000", style = {}, onClick }) => (
        <svg
          width={size}
          height={size}
          viewBox="0 0 24 24"
          fill="none"
          stroke={color}
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
          style={{ cursor: "pointer", ...style }}
          onClick={onClick}
        >
          <line x1="12" y1="5" x2="12" y2="19" />
          <line x1="5" y1="12" x2="19" y2="12" />
        </svg>
      );
      const MinusIcon = ({ size = 20, color = "#000", style = {}, onClick }) => (
        <svg
          width={size}
          height={size}
          viewBox="0 0 24 24"
          fill="none"
          stroke={color}
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
          style={{ cursor: "pointer", ...style }}
          onClick={onClick}
        >
          <line x1="5" y1="12" x2="19" y2="12" />
        </svg>
      );

      const SeanceApp = () => {
        const [selectedDate, setSelectedDate] = useState(new Date());
        const [showDatePicker, setShowDatePicker] = useState(false);
        const [showCinemaSelector, setShowCinemaSelector] = useState(false);
        const [showtimesData, setShowtimesData] = useState(null);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        const [expandedFilm, setExpandedFilm] = useState(null);
        const [loaderVisible, setLoaderVisible] = useState(true);
        const [loaderExit, setLoaderExit] = useState(false);
        const [forceSplash, setForceSplash] = useState(true);
        const [ellipsisCount, setEllipsisCount] = useState(0);
        const [hasLoadedOnce, setHasLoadedOnce] = useState(false);
        const HEADER_HEIGHT = 56;

        const getApiUrl = () => {
          const params = new URLSearchParams(window.location.search);
          const override = params.get("api");
          if (override) return override.replace(/\/$/, "");
          const host = window.location.hostname || "";
          const isLocalHost =
            host === "localhost" ||
            host === "127.0.0.1" ||
            host.startsWith("192.168.") ||
            host.startsWith("10.") ||
            host.startsWith("172.16.");
          if (isLocalHost) {
            return `http://${host}:5001`;
          }
          return "https://seances.onrender.com";
        };
        const API_URL = getApiUrl();
        const isDemoMode = new URLSearchParams(window.location.search).get("demo") === "1";
        const PREFS_STORAGE_KEY = "seances_cinema_prefs_v1";
        const DEFAULT_SELECTED_CINEMAS = [
          "Christine Cinéma Club",
          "Filmothèque du Quartier Latin",
          "La Cinémathèque Française",
          "Le Champo",
          "Le Grand Action",
          "Le Louxor",
          "MK2 Beaubourg",
          "MK2 Quai de Loire",
          "MK2 Quai de Seine",
          "Reflet Médicis",
          "Écoles Cinéma Club",
          "UGC Ciné Cité Les Halles",
        ];

        const [selectedCinemas, setSelectedCinemas] = useState(DEFAULT_SELECTED_CINEMAS);
        const [allCinemas, setAllCinemas] = useState([]);
        const [draggedCinema, setDraggedCinema] = useState(null);
        const [isReordering, setIsReordering] = useState(false);
        const [grabbedCinema, setGrabbedCinema] = useState(null);
        const touchDragFromRef = useRef(null);
        const touchDragOverRef = useRef(null);
        const [touchOverCinema, setTouchOverCinema] = useState(null);

        const isInitialLoading = forceSplash || (loading && !hasLoadedOnce);
        const isSecondaryLoading = loading && hasLoadedOnce;

        useEffect(() => {
          if (isInitialLoading) {
            setLoaderVisible(true);
            setLoaderExit(false);
            return;
          }
          if (loaderVisible) {
            setLoaderExit(true);
            const timer = setTimeout(() => {
              setLoaderVisible(false);
            }, 650);
            return () => clearTimeout(timer);
          }
        }, [isInitialLoading, loaderVisible]);

        useEffect(() => {
          const timer = setTimeout(() => {
            setForceSplash(false);
          }, 1000);
          return () => clearTimeout(timer);
        }, []);

        useEffect(() => {
          if (!loaderVisible && !isSecondaryLoading) return;
          const id = setInterval(() => {
            setEllipsisCount((count) => (count + 1) % 4);
          }, 350);
          return () => clearInterval(id);
        }, [loaderVisible, isSecondaryLoading]);

        useEffect(() => {
          if (!showCinemaSelector) return;
          window.scrollTo(0, 0);
          document.documentElement.scrollTop = 0;
          document.body.scrollTop = 0;
        }, [showCinemaSelector]);

        useEffect(() => {
          const bg = loaderVisible ? "#000000" : "#929299";
          document.documentElement.style.background = bg;
          document.body.style.background = bg;
        }, [loaderVisible]);

        useEffect(() => {
          if (isDemoMode) {
            const demoCinemas = [
              "UGC Les Halles",
              "Le Champo",
              "Reflet Médicis",
            ];
            setAllCinemas(demoCinemas);
            setSelectedCinemas(demoCinemas);
            return;
          }
          fetch(`${API_URL}/cinemas`)
            .then((res) => res.json())
            .then((data) => {
              const cinemas = data.cinemas || [];
              const byNorm = new Map(cinemas.map((name) => [normalizeCinemaName(name), name]));

              let savedOrder = [];
              let savedSelected = [];
              try {
                const raw = localStorage.getItem(PREFS_STORAGE_KEY);
                if (raw) {
                  const parsed = JSON.parse(raw);
                  savedOrder = Array.isArray(parsed?.order) ? parsed.order : [];
                  savedSelected = Array.isArray(parsed?.selected) ? parsed.selected : [];
                }
              } catch (_) {}

              const normalizedSavedOrder = savedOrder
                .map((name) => byNorm.get(normalizeCinemaName(name)))
                .filter(Boolean);
              const orderSeen = new Set(normalizedSavedOrder);
              const orderedCinemas = [
                ...normalizedSavedOrder,
                ...cinemas.filter((name) => !orderSeen.has(name)),
              ];

              const normalizedSelected = (savedSelected.length > 0 ? savedSelected : DEFAULT_SELECTED_CINEMAS)
                .map((name) => byNorm.get(normalizeCinemaName(name)))
                .filter(Boolean);
              const selectedSeen = new Set(normalizedSelected);
              const finalSelected = orderedCinemas.filter((name) => selectedSeen.has(name));

              setAllCinemas(orderedCinemas);
              setSelectedCinemas(finalSelected);
            })
            .catch((err) => {
              console.error("Erreur chargement cinémas:", err);
            });
        }, []);

        useEffect(() => {
          if (!allCinemas.length) return;
          try {
            localStorage.setItem(
              PREFS_STORAGE_KEY,
              JSON.stringify({
                order: allCinemas,
                selected: selectedCinemas,
              })
            );
          } catch (_) {}
        }, [allCinemas, selectedCinemas]);

        useEffect(() => {
          if (isDemoMode) {
            setLoading(true);
            const demoData = {
              "UGC Les Halles": [
                {
                  title: "Jusqu'à l'aube",
                  director: "Sho Miyake",
                  duration: "1h40",
                  showtimes: [
                    { start: "19:15", end: "21:29" },
                    { start: "21:45", end: "23:59" },
                  ],
                  genres: ["Comédie", "Drame"],
                  actors: ["Acteur 1", "Acteur 2", "Acteur 3", "Acteur 4", "Acteur 5"],
                  poster_url: null,
                  release_date: "2025-01-17",
                },
                {
                  title: "Les Courageux",
                  director: "Jasmine Gordon",
                  duration: "1h20",
                  showtimes: [{ start: "20:30", end: "22:05" }],
                  genres: ["Drame"],
                  actors: ["Actrice 1", "Acteur 2", "Acteur 3"],
                  poster_url: null,
                  release_date: "2024-11-10",
                },
              ],
              "Le Champo": [
                {
                  title: "Stranger Than Paradise",
                  director: "Jim Jarmusch",
                  duration: "1h51",
                  showtimes: [
                    { start: "19:00", end: "20:51" },
                    { start: "21:25", end: "23:16" },
                  ],
                  genres: ["Comédie", "Drame"],
                  actors: ["John Lurie", "Eszter Balint", "Richard Edson"],
                  poster_url: "https://fr.web.img4.acsta.net/c_160_213/img/46/dc/46dcd9002ee146bb79d3482d3f2c8fb5.jpg",
                  release_date: "1985-01-09",
                },
              ],
              "Reflet Médicis": [
                {
                  title: "Father Mother Sister Brother",
                  director: "Jim Jarmusch",
                  duration: "1h51",
                  showtimes: [{ start: "18:45", end: "20:36" }],
                  genres: ["Drame", "Romance"],
                  actors: ["Acteur 1", "Acteur 2", "Acteur 3", "Acteur 4", "Acteur 5"],
                  poster_url: null,
                  release_date: "2026-01-15",
                },
              ],
            };
            setShowtimesData(demoData);
            setLoading(false);
            setHasLoadedOnce(true);
            setError(null);
            return;
          }
          loadShowtimes();
        }, [selectedDate]);

        useEffect(() => {
          if (isDemoMode || loading || error || !showtimesData) return;
          const nextDate = new Date(selectedDate);
          nextDate.setDate(nextDate.getDate() + 1);
          const nextDateStr = nextDate.toISOString().split("T")[0];
          fetch(`${API_URL}/showtimes?date=${nextDateStr}`).catch(() => {});
        }, [selectedDate, loading, error, showtimesData]);

        const loadShowtimes = async () => {
          setLoading(true);
          setError(null);
          const dateStr = selectedDate.toISOString().split("T")[0];
          try {
            const response = await fetch(`${API_URL}/showtimes?date=${dateStr}`);
            if (!response.ok) throw new Error("Erreur API");
            const data = await response.json();
            setShowtimesData(data.showtimes);
            setLoading(false);
            setHasLoadedOnce(true);
          } catch (err) {
            setError("Impossible de charger les horaires");
            setLoading(false);
            console.error(err);
          }
        };

        const toggleCinema = (cinema) => {
          if (isReordering) return;
          if (selectedCinemas.includes(cinema)) {
            setSelectedCinemas(selectedCinemas.filter((c) => c !== cinema));
          } else {
            setSelectedCinemas([...selectedCinemas, cinema]);
          }
        };
        const moveCinema = (fromCinema, toCinema) => {
          if (!fromCinema || !toCinema || fromCinema === toCinema) return;
          setAllCinemas((prev) => {
            const from = prev.indexOf(fromCinema);
            const to = prev.indexOf(toCinema);
            if (from < 0 || to < 0) return prev;
            const next = [...prev];
            const [moved] = next.splice(from, 1);
            next.splice(to, 0, moved);
            return next;
          });
        };

        const getNextDays = () => {
          const days = [];
          for (let i = 0; i < 7; i++) {
            const date = new Date();
            date.setDate(date.getDate() + i);
            days.push(date);
          }
          return days;
        };

        const formatDate = (date) =>
          date.toLocaleDateString("fr-FR", { day: "numeric", month: "long" });

        const toggleFilmExpansion = (cinema, filmIdx) => {
          const filmKey = `${cinema}-${filmIdx}`;
          setExpandedFilm(expandedFilm === filmKey ? null : filmKey);
        };

        const formatReleaseDate = (dateStr) => {
          if (!dateStr) return "";
          const date = new Date(dateStr);
          return date.getFullYear();
        };
        const now = new Date();
        const isSelectedDateToday =
          selectedDate.toDateString() === now.toDateString();
        const isPastShowtime = (startTime) => {
          if (!isSelectedDateToday || !startTime) return false;
          const [h, m] = String(startTime).split(":").map(Number);
          if (Number.isNaN(h) || Number.isNaN(m)) return false;
          const showtimeDate = new Date(selectedDate);
          showtimeDate.setHours(h, m, 0, 0);
          return showtimeDate < now;
        };
        const normalizeCinemaName = (name) =>
          name
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/[^a-z0-9\s]/g, "")
            .replace(/\s+/g, " ")
            .trim();
        const orderedSelectedCinemas = allCinemas.filter((name) => selectedCinemas.includes(name));

        if (showCinemaSelector) {
          return (
            <div
              style={{
                fontFamily: "Helvetica, Arial, sans-serif",
                backgroundColor: "#929299",
                minHeight: "100vh",
                userSelect: "none",
                WebkitUserSelect: "none",
                WebkitTouchCallout: "none",
              }}
            >
              <div
                style={{
                  position: "sticky",
                  top: 0,
                  backgroundColor: "#000000",
                  color: "#e2e4e8",
                padding: "14px",
                  zIndex: 100,
                }}
              >
                <div
                  style={{
                    display: "flex",
                    justifyContent: "space-between",
                    alignItems: "center",
                    position: "relative",
                  }}
                >
                  <div style={{ fontSize: "24px", fontWeight: "400", color: "#c1ff00" }}>
                    Séance(s)
                  </div>
                  <div
                    style={{
                      position: "absolute",
                      left: "50%",
                      fontSize: "24px",
                      color: "#ffffff",
                    }}
                  >
                    {formatDate(selectedDate)}
                  </div>
                  <div
                    style={{
                      position: "absolute",
                      right: "0px",
                      top: "50%",
                      transform: "translateY(-50%)",
                      width: "20px",
                      textAlign: "right",
                      fontSize: "24px",
                      lineHeight: "20px",
                      color: "#929299",
                      cursor: "pointer",
                      userSelect: "none",
                    }}
                    onClick={() => setShowCinemaSelector(false)}
                  >
                    ×
                  </div>
                </div>
              </div>

              <div>
                {allCinemas.map((cinema, idx) => (
                  <div
                    key={idx}
                    draggable
                    onDragStart={() => {
                      setDraggedCinema(cinema);
                      setGrabbedCinema(cinema);
                    }}
                    onDragEnd={() => {
                      setDraggedCinema(null);
                      setGrabbedCinema(null);
                    }}
                    onDragOver={(e) => e.preventDefault()}
                    data-cinema-row="1"
                    data-cinema-name={cinema}
                      onDrop={(e) => {
                        e.preventDefault();
                        moveCinema(draggedCinema, cinema);
                        setDraggedCinema(null);
                        setGrabbedCinema(null);
                      }}
                      onClick={() => toggleCinema(cinema)}
                    style={{
                      padding: "14px",
                      paddingRight: "52px",
                      fontSize: "24px",
                      fontWeight: "400",
                      color: "#000000",
                      backgroundColor: selectedCinemas.includes(cinema) ? "#c1ff00" : "#929299",
                      borderBottom: "1px solid #000000",
                      borderTop:
                        isReordering && touchOverCinema === cinema
                          ? "3px solid #000000"
                          : "0px solid transparent",
                      cursor: "pointer",
                      transition: "background-color 0.2s",
                      position: "relative",
                      userSelect: "none",
                      WebkitUserSelect: "none",
                      WebkitTouchCallout: "none",
                    }}
                  >
                    <span
                      style={{
                        display: "inline-block",
                        transform: grabbedCinema === cinema ? "translateX(14px)" : "translateX(0px)",
                        transition: "transform 120ms ease",
                      }}
                    >
                      {cinema}
                    </span>
                    <span
                      style={{
                        position: "absolute",
                        right: "6px",
                        top: "50%",
                        transform: "translateY(-50%)",
                        width: "32px",
                        height: "32px",
                        display: "flex",
                        alignItems: "center",
                        justifyContent: "center",
                        textAlign: "right",
                        fontSize: "24px",
                        lineHeight: "24px",
                        color: "#3b3b3f",
                        letterSpacing: "0",
                        userSelect: "none",
                        touchAction: "none",
                        cursor: "grab",
                      }}
                      onMouseDown={(e) => e.stopPropagation()}
                      onTouchStart={(e) => {
                        e.stopPropagation();
                        touchDragFromRef.current = cinema;
                        touchDragOverRef.current = cinema;
                        setGrabbedCinema(cinema);
                        setTouchOverCinema(cinema);
                        setIsReordering(true);
                      }}
                      onTouchMove={(e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const touch = e.touches && e.touches[0];
                        if (!touch) return;
                        const el = document.elementFromPoint(touch.clientX, touch.clientY);
                        const row = el && el.closest ? el.closest('[data-cinema-row="1"]') : null;
                        const overCinema = row ? row.getAttribute("data-cinema-name") : null;
                        if (overCinema) {
                          touchDragOverRef.current = overCinema;
                          setTouchOverCinema(overCinema);
                        }
                      }}
                      onTouchEnd={(e) => {
                        e.stopPropagation();
                        moveCinema(touchDragFromRef.current, touchDragOverRef.current);
                        touchDragFromRef.current = null;
                        touchDragOverRef.current = null;
                        setGrabbedCinema(null);
                        setTouchOverCinema(null);
                        setTimeout(() => setIsReordering(false), 0);
                      }}
                      onTouchCancel={(e) => {
                        e.stopPropagation();
                        touchDragFromRef.current = null;
                        touchDragOverRef.current = null;
                        setGrabbedCinema(null);
                        setTouchOverCinema(null);
                        setTimeout(() => setIsReordering(false), 0);
                      }}
                    >
                      ⋮
                    </span>
                  </div>
                ))}
              </div>
            </div>
          );
        }

        return (
          <div
            style={{
              fontFamily: "Helvetica, Arial, sans-serif",
              backgroundColor: "#929299",
              minHeight: "100vh",
              paddingBottom: "40px",
            }}
          >
            <div
              style={{
                position: "sticky",
                top: 0,
                backgroundColor: "#000000",
                color: "#e2e4e8",
                padding: "14px",
                zIndex: 100,
              }}
            >
              <div
                style={{
                  display: "flex",
                  justifyContent: "space-between",
                  alignItems: "center",
                  position: "relative",
                }}
              >
                <div style={{ fontSize: "24px", fontWeight: "400", color: "#c1ff00" }}>
                  Séance(s)
                </div>
                <div
                  onClick={() => setShowDatePicker(!showDatePicker)}
                  style={{
                    position: "absolute",
                    left: "50%",
                    fontSize: "24px",
                    color: "#ffffff",
                    cursor: "pointer",
                    userSelect: "none",
                  }}
                >
                  {formatDate(selectedDate)}
                </div>
                {!isSecondaryLoading ? (
                  <div
                    style={{
                      position: "absolute",
                      right: "0px",
                      top: "50%",
                      transform: "translateY(-50%)",
                      width: "20px",
                      textAlign: "right",
                      fontSize: "24px",
                      lineHeight: "20px",
                      color: "#929299",
                      cursor: "pointer",
                      userSelect: "none",
                    }}
                    onClick={() => setShowCinemaSelector(true)}
                  >
                    +
                  </div>
                ) : (
                  <div className="seances-header-ellipsis">
                    {["   ", ".  ", ".. ", "..."][ellipsisCount]}
                  </div>
                )}
              </div>
            </div>

            {showDatePicker && (
              <div
                style={{
                  position: "fixed",
                  top: "56px",
                  left: 0,
                  right: 0,
                  bottom: 0,
                  backgroundColor: "#929299",
                  zIndex: 99,
                  overflowY: "auto",
                }}
              >
                {getNextDays().map((date, idx) => (
                  <div
                    key={idx}
                    onClick={() => {
                      setSelectedDate(date);
                      setShowDatePicker(false);
                    }}
                    style={{
                      padding: "14px",
                      paddingLeft: "50%",
                      fontSize: "24px",
                      cursor: "pointer",
                      color: "#000000",
                      backgroundColor:
                        date.toDateString() === selectedDate.toDateString()
                          ? "#c1ff00"
                          : "#929299",
                      borderBottom: "1px solid #000000",
                      transition: "background-color 0.2s",
                    }}
                  >
                    {formatDate(date)}
                  </div>
                ))}
              </div>
            )}

            {loading && (
              <></>
            )}

            {loaderVisible && (
              <div
                className="seances-loading-overlay"
                style={{
                  height: loaderExit ? `${HEADER_HEIGHT}px` : "100svh",
                }}
              >
                <div className="seances-loading-logo">Séance(s)</div>
                <div className="seances-loading-ellipsis">
                  {["   ", ".  ", ".. ", "..."][ellipsisCount]}
                </div>
              </div>
            )}

            {isSecondaryLoading && <div className="seances-secondary-overlay" />}

            {error && (
              <div
                style={{
                  padding: "40px",
                  textAlign: "center",
                  fontSize: "18px",
                  color: "#ff0000",
                }}
              >
                {error}
                <div style={{ marginTop: "8px", fontSize: "12px", color: "#333" }}>
                  API: {API_URL}
                </div>
                <div
                  onClick={loadShowtimes}
                  style={{
                    marginTop: "16px",
                    padding: "12px 24px",
                    backgroundColor: "#000000",
                    color: "#ffffff",
                    cursor: "pointer",
                    display: "inline-block",
                    borderRadius: "4px",
                  }}
                >
                  Réessayer
                </div>
              </div>
            )}

            {!loading &&
              !error &&
              showtimesData &&
              orderedSelectedCinemas.map((cinema, cinemaIdx) => {
                const showtimeKeys = Object.keys(showtimesData || {});
                const keyByNormalized = new Map(
                  showtimeKeys.map((name) => [normalizeCinemaName(name), name])
                );
                const resolvedName =
                  keyByNormalized.get(normalizeCinemaName(cinema)) || cinema;
                const films = showtimesData[resolvedName] || [];
                if (films.length === 0) return null;

                return (
                  <div key={cinemaIdx}>
                    <div
                      style={{
                        position: "sticky",
                        top: "56px",
                        backgroundColor: "#929299",
                        padding: "14px",
                        fontSize: "24px",
                        fontWeight: "400",
                        color: "#000000",
                        borderBottom: "1px solid #000000",
                        zIndex: 50,
                      }}
                    >
                      {resolvedName}
                    </div>

                    {films.map((film, filmIdx) => {
                      const filmKey = `${cinema}-${filmIdx}`;
                      const isExpanded = expandedFilm === filmKey;
                      const compactTopPadding = "10px";
                      const compactBottomPadding = isExpanded ? "0" : "14px";
                      return (
                        <div
                          key={filmIdx}
                          style={{
                            backgroundColor: isExpanded ? "#ffffff" : "#929299",
                            borderBottom: "1px solid #000000",
                            paddingLeft: "14px",
                            paddingRight: "14px",
                            paddingTop: compactTopPadding,
                            paddingBottom: compactBottomPadding,
                            position: "relative",
                            cursor: "pointer",
                          }}
                          onClick={() => toggleFilmExpansion(cinema, filmIdx)}
                        >
                          {!isExpanded && (
                            <>
                              <div
                                style={{
                                  display: "grid",
                                  gridTemplateColumns: "minmax(0, 1fr) minmax(0, 1fr)",
                                  columnGap: "0px",
                                  minWidth: 0,
                                }}
                              >
                                <div
                                  style={{
                                    fontFamily: '"EB Garamond", serif',
                                    fontSize: "16px",
                                    color: "#000000",
                                    maxWidth: "100%",
                                    minWidth: 0,
                                    paddingRight: "15px",
                                  }}
                                >
                                  <div className="seances-garamond seances-title seances-ellipsis">{film.title}</div>
                                  <div className="seances-garamond seances-director seances-ellipsis">{film.director || "Réalisateur inconnu"}</div>
                                  <div className="seances-garamond seances-duration">{film.duration || "Durée inconnue"}</div>
                                </div>

                                <div
                                  style={{
                                    fontFamily: '"EB Garamond", serif',
                                    fontSize: "16px",
                                    lineHeight: "18px",
                                    color: "#000000",
                                    textAlign: "left",
                                  }}
                                >
                                  {film.showtimes.map((time, timeIdx) => (
                                    <div
                                      key={timeIdx}
                                      style={{
                                        marginBottom:
                                          timeIdx < film.showtimes.length - 1 ? "4px" : "0",
                                        opacity: isPastShowtime(time.start) ? 0.4 : 1,
                                      }}
                                    >
                                      <span style={{ fontWeight: "600" }}>{time.start}</span>
                                      <span>{"\u00a0\u00a0"}(→ {time.end})</span>
                                    </div>
                                  ))}
                                </div>
                              </div>
                            </>
                          )}

                          {isExpanded && (
                            <div
                              style={{
                                display: "grid",
                                gridTemplateColumns: "minmax(0, 1fr) minmax(0, 1fr)",
                                columnGap: "0px",
                                minWidth: 0,
                              }}
                            >
                              <div className="seances-garamond seances-title seances-ellipsis" style={{ paddingRight: "15px" }}>
                                {film.title}
                              </div>
                              <div className="seances-garamond">
                                {film.genres && film.genres.length > 0 ? film.genres[0] : ""}
                              </div>

                              <div className="seances-garamond seances-director seances-ellipsis" style={{ paddingRight: "15px" }}>
                                {film.director || "Réalisateur inconnu"}
                              </div>
                              <div className="seances-garamond">
                                {film.genres && film.genres.length > 1 ? film.genres[1] : ""}
                              </div>

                              <div className="seances-garamond seances-duration" style={{ paddingRight: "15px", marginBottom: "12px" }}>
                                {film.duration || "Durée inconnue"}
                              </div>
                              <div className="seances-garamond">
                                {film.release_date ? formatReleaseDate(film.release_date) : ""}
                              </div>

                              <div className="seances-garamond" style={{ paddingRight: "15px" }}>
                                {film.actors && film.actors.length > 0 && (
                                  <>
                                    <div className="seances-avec">Avec :</div>
                                    {film.actors.slice(0, 5).map((actor, idx) => (
                                      <div key={idx}>{actor}</div>
                                    ))}
                                  </>
                                )}
                              </div>
                              <div style={{ marginRight: "-20px" }}>
                                {film.poster_url ? (
                                  <img
                                    src={film.poster_url}
                                    alt={film.title}
                                    style={{
                                      width: "100%",
                                      height: "auto",
                                      objectFit: "cover",
                                      display: "block",
                                      marginTop: "6px",
                                    }}
                                  />
                                ) : (
                                  <div
                                    style={{
                                      width: "100%",
                                      height: "260px",
                                      backgroundColor: "#e6e6e6",
                                      marginTop: "6px",
                                    }}
                                  />
                                )}
                              </div>
                            </div>
                          )}

                          {isExpanded && film.letterboxd_url && (
                            <a
                              href={film.letterboxd_url}
                              target="_blank"
                              rel="noopener noreferrer"
                              style={{
                                position: "absolute",
                                left: "14px",
                                bottom: "14px",
                                display: "block",
                                margin: 0,
                                padding: 0,
                                lineHeight: 0,
                                zIndex: 2,
                              }}
                              onClick={(e) => e.stopPropagation()}
                            >
                              <img
                                src="letterboxd_logo.svg"
                                alt="Letterboxd"
                                style={{
                                  width: "42px",
                                  height: "auto",
                                  display: "block",
                                }}
                              />
                            </a>
                          )}

                          <div
                            style={{
                              position: "absolute",
                              right: "14px",
                              top: "10px",
                              transform: "translateY(-2px)",
                              fontFamily: '"EB Garamond", serif',
                              fontSize: "20px",
                              lineHeight: "20px",
                              color: "#000000",
                              userSelect: "none",
                            }}
                            onClick={(e) => {
                              e.stopPropagation();
                              toggleFilmExpansion(cinema, filmIdx);
                            }}
                          >
                            {isExpanded ? "–" : "+"}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                );
              })}

            {!loading &&
              !error &&
              showtimesData &&
              orderedSelectedCinemas.length > 0 &&
              orderedSelectedCinemas.every((cinema) => {
                const showtimeKeys = Object.keys(showtimesData || {});
                const keyByNormalized = new Map(
                  showtimeKeys.map((name) => [normalizeCinemaName(name), name])
                );
                const resolvedName =
                  keyByNormalized.get(normalizeCinemaName(cinema)) || cinema;
                return (showtimesData[resolvedName] || []).length === 0;
              }) && (
                <div
                  style={{
                    padding: "40px",
                    textAlign: "center",
                    fontSize: "16px",
                    color: "#000000",
                  }}
                >
                  Aucun film pour les cinémas sélectionnés.
                  <div style={{ marginTop: "8px", fontSize: "12px", color: "#333" }}>
                    API: {API_URL}
                  </div>
                  <div style={{ marginTop: "12px", fontSize: "12px", color: "#333" }}>
                    Cinémas reçus:
                  </div>
                  <div style={{ marginTop: "6px", fontSize: "12px", color: "#333" }}>
                    {(showtimesData && Object.keys(showtimesData).slice(0, 6).map((name) => (
                      <div key={name}>
                        {name} — {(showtimesData[name] || []).length} films
                      </div>
                    )))}
                  </div>
                  <div
                    onClick={loadShowtimes}
                    style={{
                      marginTop: "16px",
                      padding: "12px 24px",
                      backgroundColor: "#000000",
                      color: "#ffffff",
                      cursor: "pointer",
                      display: "inline-block",
                      borderRadius: "4px",
                    }}
                  >
                    Recharger
                  </div>
                </div>
              )}

            {!loading && !error && !showtimesData && (
              <div
                style={{
                  padding: "40px",
                  textAlign: "center",
                  fontSize: "16px",
                  color: "#000000",
                }}
              >
                Aucune donnée chargée.
                <div style={{ marginTop: "8px", fontSize: "12px", color: "#333" }}>
                  API: {API_URL}
                </div>
                <div
                  onClick={loadShowtimes}
                  style={{
                    marginTop: "16px",
                    padding: "12px 24px",
                    backgroundColor: "#000000",
                    color: "#ffffff",
                    cursor: "pointer",
                    display: "inline-block",
                    borderRadius: "4px",
                  }}
                >
                  Recharger
                </div>
              </div>
            )}

            {!loading && !error && showtimesData && selectedCinemas.length === 0 && (
              <div
                style={{
                  padding: "40px",
                  textAlign: "center",
                  fontSize: "16px",
                  color: "#000000",
                }}
              >
                Aucun cinéma sélectionné.
                <div
                  onClick={() => setShowCinemaSelector(true)}
                  style={{
                    marginTop: "16px",
                    padding: "12px 24px",
                    backgroundColor: "#000000",
                    color: "#ffffff",
                    cursor: "pointer",
                    display: "inline-block",
                    borderRadius: "4px",
                  }}
                >
                  Choisir des cinémas
                </div>
              </div>
            )}
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<SeanceApp />);
    </script>
  </body>
</html>
